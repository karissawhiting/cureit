---
title: "Analyze Variant Data"
output: html_document
date: "2023-02-15"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
library(cureit)
library(ggsurvfit)
library(labelled)
library(gtsummary)
library(survival)
library(tidycmprsk)
library(tidyverse)
theme_gtsummary_compact()
load(here::here("inst", "deid_data_2022-09-02[1526].RData"))
df <- df_sel
# Summary ------
fit <- survfit(Surv(os_months, dod) ~ 1, data = df_sel)
```

```{r }
ggsurvfit(fit) + ylim(0, 1) + 
  add_risktable() + theme_classic()
```

```{r}
process_reg_table <- function(tbl_reg) {
    
  tbl_reg$table_body <- tbl_reg$table_body %>%
    separate_wider_delim(
      label,
      names = c("label", "label2"), 
             delim = ",")%>%
    separate_wider_delim(
      variable,
      names = c("variable", "variable2"), 
             delim = ",")
  
  cure <- tbl_reg
  cure$table_body <- cure$table_body %>%
    filter(label2 == " Cure model") %>%
    filter(label != "(Intercept)")
  
  surv <- tbl_reg
  surv$table_body <- surv$table_body%>%
    filter(label2 == " Survival model")
  
  tbl_merge(list(cure, surv), 
            tab_spanner = c("Cure Model",
                            "Survival Model"))
}
```


This report uses data from Bartlett et al. 2019 to model death from disease, local recurrence, and distant recurrence using mixture cure models. 

The original paper modeled these three endpoints using competing risks methods to analyze prognostic significance of histologic subtypes in liposarcoma.  

Since the cohort has a high proportion of individuals who do not experience the event, mixture cure models may be more suited to explicitly model survival as a mixture of two types of patients: those who are "cured" (will not experience event during follow-up time) and those who are not. Using mixture cure models, we can estimate the proportion of long term survivors and also describe the time to event among those who are not "cured". Using this formulation, we can investigate patient characteristics that are related to each of the model components. 

# Cohort Summaries


```{r}
df <- df %>%
  mutate(site2 = case_when(
    site1_name %in% c("Lower extremity", "Upper extremity") ~ "Lower/upper Extremity", 
    TRUE ~ site1_name))
df <- df %>%
  set_variable_labels(.labels = kwiktools::names_to_labels(.))
var_label(df) <- list(
  sex_dscrp = "Sex",
  depth_dscrp = "Depth",
  size_category_dscrp = "Size Categorized"
)
df_cure <- df %>%
  mutate(dod = case_when(death == 1 ~ 1, 
                         (death == 2 | death == 0) ~ 0, 
                         TRUE ~ NA_real_)) 
#%>%
#  filter(resection_category != "Unknown")

df <- df_cure
```

```{r}
df %>%
  select(
         variant_name_specify,
         age_presentation, 
         sex_dscrp,
         site1_name, 
         max_tumor_size,
         size_category_dscrp, 
         depth_dscrp, 
         resection_category, 
         bone_invasion, 
         chemo_sequence, 
         rt_sequence) %>%
  tbl_summary(by = "variant_name_specify") %>% 
  bold_labels() %>%
  add_p() %>% 
  add_overall() %>%
  bold_p()
```

# Endpoints 


```{r}
df %>%
  select(death) %>% 
  tbl_summary(label = death ~ "Death (1 is disease-related)") %>%
  bold_labels()
```

<br>

```{r}
df %>%
  select(lr_y_n) %>% 
  tbl_summary(label = lr_y_n ~ "Local Recurrence") %>%
  bold_labels()
```

<br> 

```{r}
df %>%
  select(dr_y_n) %>% 
  tbl_summary(label = dr_y_n ~ "Distant Recurrence") %>%
  bold_labels()
```

<br>



# Univariable Cure Model


```{r}

uni_func <- function(var, df_input, nboot) {
  df <- df_input %>% 
    select("os_months",
           "dod",
           var) %>%
  na.omit()
  

  f_surv <- as.formula(paste0("Surv(os_months, dod) ~ ", var))
  f_cure <- as.formula(paste0("~ ", var))
  
  
  p <- cureit(surv_formula = f_surv,
            cure_formula = f_cure,
            data = df,
            nboot = nboot)
  p

}
```

```{r, eval=FALSE}
nboot = 500

age_uni <- uni_func("age_presentation", df,
                    nboot = 500)
save(age_uni, file = here::here("inst",
                         "model-fits",
                         "age_uni_2023"))
age_uni$tidy

v_uni <- uni_func("variant_name_specify", df,
                  nboot = 500)
save(v_uni, file = here::here("inst",
                         "model-fits",
                         "v_uni_2023"))
v_uni$tidy

sex_uni <- uni_func("sex_dscrp", df,
                    nboot = 500)
save(sex_uni, file = here::here("inst",
                         "model-fits",
                         "sex_uni_2023"))

site_uni <- uni_func("site1_name", df,
                    nboot = 500)
save(site_uni, file = here::here("inst",
                         "model-fits",
                         "site_uni_2023"))

maxsize_uni <- uni_func("max_tumor_size", df,
                    nboot = 500)
save(maxsize_uni, file = here::here("inst",
                         "model-fits",
                         "maxsize_uni_2023"))

dep_uni <- uni_func("depth_dscrp", df,
                    nboot = 500)
save(dep_uni, file = here::here("inst",
                         "model-fits",
                         "dep_uni_uni_2023"))

load(here::here("inst",
                         "model-fits",
                         "dep_uni_uni_2023"))

df2 <- df %>%
  filter(resection_category != "Unknown")
res_uni <- uni_func("resection_category", df2,
                    nboot = 500)
save(res_uni, file = here::here("inst",
                         "model-fits",
                         "res_uni_2023"))


df2 <- df %>%
  mutate(log_tumor_size = log(max_tumor_size, 2))

logsize_uni <- uni_func("log_tumor_size", df2,
                    nboot = 500)

save(logsize_uni, file = here::here("inst",
                         "model-fits",
                         "logsize_uni_2023"))

```

```{r}

model_fits <- list.files(
  here::here("inst", "model-fits"), full.names = TRUE)

for(i in 1:length(model_fits)) load(model_fits[[i]]) 
```

```{r }
reg_tbl <- map(list(age_uni, v_uni, sex_uni,
                    site_uni, maxsize_uni, logsize_uni, res_uni),
               ~tbl_regression(.x, 
                               exponentiate = TRUE, 
                               tidy_fun = cureit::tidy))

x <- tbl_stack(reg_tbl) %>%
  bold_labels() %>%
  bold_p()

x$table_body <- x$table_body %>%
  separate_wider_delim(
    label,
    names = c("label", "label2"), 
           delim = ",")%>%
  separate_wider_delim(
    variable,
    names = c("variable", "variable2"), 
           delim = ",")

cure <- x

cure$table_body <- cure$table_body%>%
  filter(label2 == " Cure model") %>%
  filter(label != "(Intercept)")

cure

surv <- x

surv$table_body <- surv$table_body%>%
  filter(label2 == " Survival model")

surv

tbl_merge(list(cure, surv), 
          tab_spanner = c("Cure Model",
                          "Survival Model"))



```


<br>

# Multivariable Models

## Subtype, Size


```{r, eval=FALSE}
multi1  <- cureit(surv_formula = Surv(os_months, dod) ~ variant_name_specify + 
                  log(max_tumor_size, 2),
                  cure_formula = ~ variant_name_specify + 
                  log(max_tumor_size, 2),
                data = df_cure,
                nboot = 500)
save(multi1, file =  here::here("inst", "model-fits", "multi1.Rd"))

multi20  <- cureit(surv_formula = Surv(os_months, dod) ~ variant_name_specify + 
                  max_tumor_size,
                  cure_formula = ~ variant_name_specify + 
                  max_tumor_size,
                data = df_cure,
                nboot = 10)

multi50 %>% 
  tbl_regression(tidy_fun = tidy, exponentiate = TRUE) %>%
  process_reg_table()

save(multi20, file =  here::here("inst", "model-fits", "multi20.Rd"))
```

```{r }
load(here::here("inst", "model-fits", "multi1.Rd"))

z <- multi1 %>% 
  tbl_regression(tidy_fun = cureit::tidy, exponentiate = TRUE)

process_reg_table(z)
```

```{r}

x$table_body <- x$table_body %>%
  separate_wider_delim(
    label,
    names = c("label", "label2"), 
           delim = ",")%>%
  separate_wider_delim(
    variable,
    names = c("variable", "variable2"), 
           delim = ",")

cure <- x

cure$table_body <- cure$table_body%>%
  filter(label2 == " Cure model") %>%
  filter(label != "(Intercept)")

cure

surv <- x

surv$table_body <- surv$table_body%>%
  filter(label2 == " Survival model")

surv

tbl_merge(list(cure, surv), 
          tab_spanner = c("Cure Model",
                          "Survival Model"))

```

### Brier

```{r}
pred <- predict(multi1,
                method="prob",
                times=seq(0,380,10),
                brier=TRUE,
                cox=TRUE)

plot(seq(10,390,10), pred$brier,type="s",xlab="Time",ylab="Brier score",ylim=c(0,0.15))
lines(seq(10,390,10), pred$brier_cox,type="s",col="red")
legend("topleft",c("Cure model","Cox model"),col=c("black","red"),lty=1)

pred1 <- pred

```

```{r}
times <- seq(5, 24, 0.5)
bootbrier <- Brier_inference_bootstrap(multi1, times = times, nboot = 2)
```

## Subtype, Size, Depth


```{r}
multi2  <- cureit(surv_formula = Surv(os_months, dod) ~ variant_name_specify + 
                    depth_dscrp +
                  log(max_tumor_size, 2),
                  cure_formula = ~ variant_name_specify + depth_dscrp +
                  log(max_tumor_size, 2),
                data = df_cure,
                nboot = 500)

multi2 %>% tbl_regression(tidy_fun = tidy, exponentiate = TRUE)

save(multi2, file =  here::here("inst", "model-fits", "multi2.Rd"))
```


## Subtype, Size, Depth, Site


```{r}
multi3  <- cureit(surv_formula = Surv(os_months, dod) ~
                    variant_name_specify + 
                    depth_dscrp +
                  log(max_tumor_size, 2) + 
                    site1_name,
                  
                  cure_formula = ~ variant_name_specify +
                    depth_dscrp +
                  log(max_tumor_size, 2) +
                    site1_name,
                data = df_cure,
                nboot = 500)

multi3 %>% tbl_regression(tidy_fun = tidy, exponentiate = TRUE) %>%
  process_reg_table()

save(multi3, file =  here::here("inst", "model-fits", "multi3.Rd"))
```

